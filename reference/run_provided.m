% --- Load some settings for prettyplot
set_groot 

% --- Presumed location of the Tonga volcano
tonga_latlon = [-20.550, -175.385]; % latitude and longitude

% --- Data sources
data_folder = '/Users/svenpn/vcs/eckel_infrasection/downloader/data_1/h5'; % Modifiy this to point to where you have saved the data
fn_list = { ...
  'AM.R0033_unfilt.h5', ...
  'AM.R0318_unfilt.h5', ...
  'AM.R0352_unfilt.h5', ...
  'AM.R03EA_unfilt.h5', ...
  'AM.R06C4_unfilt.h5', ...
  'AM.R06CE_unfilt.h5', ...
  'AM.R0835_unfilt.h5', ...
  'AM.R08DA_unfilt.h5', ...
  'AM.R095E_unfilt.h5', ...
  'AM.R0C1F_unfilt.h5', ...
  'AM.R1033_unfilt.h5', ...
  'AM.R10D3_unfilt.h5', ...
  'AM.R10DB_unfilt.h5', ...
  'AM.R13D2_unfilt.h5', ...
  'AM.R160F_unfilt.h5', ...
  'AM.R167F_unfilt.h5', ...
  'AM.R176D_unfilt.h5', ...
  'AM.R17FC_unfilt.h5', ...
  'AM.R18EB_unfilt.h5', ...
  'AM.R1936_unfilt.h5', ...
  'AM.R199D_unfilt.h5', ...
  'AM.R216B_unfilt.h5', ...
  'AM.R25AC_unfilt.h5', ...
  'AM.R25D6_unfilt.h5', ...
  'AM.R266F_unfilt.h5', ...
  'AM.R2883_unfilt.h5', ...
  'AM.R2BFC_unfilt.h5', ...
  'AM.R2C45_unfilt.h5', ...
  'AM.R2D80_unfilt.h5', ...
  'AM.R2DDD_unfilt.h5', ...
  'AM.R2FF1_unfilt.h5', ...
  'AM.R3333_unfilt.h5', ...
  'AM.R3412_unfilt.h5', ...
  'AM.R347E_unfilt.h5', ...
  'AM.R3609_unfilt.h5', ...
  'AM.R3635_unfilt.h5', ...
  'AM.R3740_unfilt.h5', ...
  'AM.R3786_unfilt.h5', ...
  'AM.R3812_unfilt.h5', ...
  'AM.R39A8_unfilt.h5', ...
  'AM.R3A9B_unfilt.h5', ...
  'AM.R3F75_unfilt.h5', ...
  'AM.R40C1_unfilt.h5', ...
  'AM.R438F_unfilt.h5', ...
  'AM.R44DC_unfilt.h5', ...
  'AM.R45FA_unfilt.h5', ...
  'AM.R4649_unfilt.h5', ...
  'AM.R489A_unfilt.h5', ...
  'AM.R4A5A_unfilt.h5', ...
  'AM.R4B63_unfilt.h5', ...
  'AM.R4BA9_unfilt.h5', ...
  'AM.R4F67_unfilt.h5', ...
  'AM.R5419_unfilt.h5', ...
  'AM.R56C6_unfilt.h5', ...
  'AM.R571C_unfilt.h5', ...
  'AM.R5754_unfilt.h5', ...
  'AM.R5A2C_unfilt.h5', ...
  'AM.R5C9B_unfilt.h5', ...
  'AM.R6093_unfilt.h5', ...
  'AM.R63E7_unfilt.h5', ...
  'AM.R6936_unfilt.h5', ...
  'AM.R6BD0_unfilt.h5', ...
  'AM.R6CB0_unfilt.h5', ...
  'AM.R6F55_unfilt.h5', ...
  'AM.R7266_unfilt.h5', ...
  'AM.R75C2_unfilt.h5', ...
  'AM.R796B_unfilt.h5', ...
  'AM.R79F9_unfilt.h5', ...
  'AM.R7BC1_unfilt.h5', ...
  'AM.R7D02_unfilt.h5', ...
  'AM.R7D64_unfilt.h5', ...
  'AM.R834D_unfilt.h5', ...
  'AM.R85CD_unfilt.h5', ...
  'AM.R884B_unfilt.h5', ...
  'AM.R8866_unfilt.h5', ...
  'AM.R8A3D_unfilt.h5', ...
  'AM.R8AC9_unfilt.h5', ...
  'AM.R8CB3_unfilt.h5', ...
  'AM.R8D5C_unfilt.h5', ...
  'AM.R940D_unfilt.h5', ...
  'AM.R94AB_unfilt.h5', ...
  'AM.R94FB_unfilt.h5', ...
  'AM.R9606_unfilt.h5', ...
  'AM.R9767_unfilt.h5', ...
  'AM.R991C_unfilt.h5', ...
  'AM.R99EA_unfilt.h5', ...
  'AM.R9C27_unfilt.h5', ...
  'AM.R9CDF_unfilt.h5', ...
  'AM.R9D92_unfilt.h5', ...
  'AM.R9F0D_unfilt.h5', ...
  'AM.RA25D_unfilt.h5', ...
  'AM.RA461_unfilt.h5', ...
  'AM.RA48E_unfilt.h5', ...
  'AM.RA538_unfilt.h5', ...
  'AM.RA5CA_unfilt.h5', ...
  'AM.RA8D4_unfilt.h5', ...
  'AM.RAEE3_unfilt.h5', ...
  'AM.RAF39_unfilt.h5', ...
  'AM.RAFE2_unfilt.h5', ...
  'AM.RB3C2_unfilt.h5', ...
  'AM.RB46B_unfilt.h5', ...
  'AM.RB5CE_unfilt.h5', ...
  'AM.RB6FC_unfilt.h5', ...
  'AM.RB83C_unfilt.h5', ...
  'AM.RBE98_unfilt.h5', ...
  'AM.RBED8_unfilt.h5', ...
  'AM.RC170_unfilt.h5', ...
  'AM.RC1DA_unfilt.h5', ...
  'AM.RC4FB_unfilt.h5', ...
  'AM.RC59E_unfilt.h5', ...
  'AM.RC662_unfilt.h5', ...
  'AM.RC865_unfilt.h5', ...
  'AM.RC93C_unfilt.h5', ...
  'AM.RCB56_unfilt.h5', ...
  'AM.RCC6E_unfilt.h5', ...
  'AM.RCD03_unfilt.h5', ...
  'AM.RCDB6_unfilt.h5', ...
  'AM.RD120_unfilt.h5', ...
  'AM.RD2F0_unfilt.h5', ...
  'AM.RD44E_unfilt.h5', ...
  'AM.RD59C_unfilt.h5', ...
  'AM.RD617_unfilt.h5', ...
  'AM.RD7C1_unfilt.h5', ...
  'AM.RD8B4_unfilt.h5', ...
  'AM.RDACF_unfilt.h5', ...
  'AM.RDF00_unfilt.h5', ...
  'AM.RE1B7_unfilt.h5', ...
  'AM.RE582_unfilt.h5', ...
  'AM.RE991_unfilt.h5', ...
  'AM.REAF3_unfilt.h5', ...
  'AM.REB60_unfilt.h5', ...
  'AM.REDDF_unfilt.h5', ...
  'AM.RF082_unfilt.h5', ...
  'AM.RF2BA_unfilt.h5', ...
  'AM.RF356_unfilt.h5', ...
  'AM.RF3D1_unfilt.h5', ...
  'AM.RFCA1_unfilt.h5', ...
  'AM.S3774_unfilt.h5', ...
  'AM.S6197_unfilt.h5', ...
  'AM.S89A5_unfilt.h5', ...
  'AV.ADKI_unfilt.h5', ...
  'AV.AMKA_unfilt.h5', ...
  'AV.CLES1_unfilt.h5', ...
  'AV.DLL_unfilt.h5', ...
  'AV.KENI_unfilt.h5', ...
  'AV.SDPI_unfilt.h5', ...
  'AV.WHTR_unfilt.h5', ...
  'CC.GUAC_unfilt.h5', ...
  'GR.I26H1_unfilt.h5', ...
  'GR.I26H2_unfilt.h5', ...
  'GR.I26H3_unfilt.h5', ...
  'GR.I26H4_unfilt.h5', ...
  'GR.I26H5_unfilt.h5', ...
  'GR.I26H6_unfilt.h5', ...
  'GR.I26H7_unfilt.h5', ...
  'GR.I26H8_unfilt.h5', ...
  'GR.IGAH1_unfilt.h5', ...
  'GR.IGAH4_unfilt.h5', ...
  'GS.VEA1_unfilt.h5', ...
  'HV.WALE_unfilt.h5', ...
  'IU.ANMO_unfilt.h5', ...
  'NL.CIA06_unfilt.h5', ...
  'NL.CIA07_unfilt.h5', ...
  'NL.DBN01_unfilt.h5', ...
  'NL.DBN02_unfilt.h5', ...
  'NL.DBN03_unfilt.h5', ...
  'NL.DBN04_unfilt.h5', ...
  'NL.DBN05_unfilt.h5', ...
  'NL.DBN06_unfilt.h5', ...
  'NL.DL01_unfilt.h5', ...
  'NL.DL14_unfilt.h5', ...
  'NL.DL17_unfilt.h5', ...
  'NL.EXL01_unfilt.h5', ...
  'NL.EXL02_unfilt.h5', ...
  'NL.EXL03_unfilt.h5', ...
  'NL.EXL04_unfilt.h5', ...
  'NL.EXL06_unfilt.h5', ...
  'NL.L206_unfilt.h5', ...
  'NL.L208_unfilt.h5', ...
  'NL.L406_unfilt.h5', ...
  'NL.L509_unfilt.h5', ...
  'NZ.COVZ_unfilt.h5', ...
  'NZ.ETVZ_unfilt.h5', ...
  'NZ.FWVZ_unfilt.h5', ...
  'NZ.IVVZ_unfilt.h5', ...
  'NZ.KHEZ_unfilt.h5', ...
  'NZ.KRVZ_unfilt.h5', ...
  'NZ.MAVZ_unfilt.h5', ...
  'NZ.NEZ_unfilt.h5', ...
  'NZ.NGZ_unfilt.h5', ...
  'NZ.NOVZ_unfilt.h5', ...
  'NZ.NTVZ_unfilt.h5', ...
  'NZ.OTVZ_unfilt.h5', ...
  'NZ.PREZ_unfilt.h5', ...
  'NZ.SNVZ_unfilt.h5', ...
  'NZ.TMVZ_unfilt.h5', ...
  'NZ.TOVZ_unfilt.h5', ...
  'NZ.TRVZ_unfilt.h5', ...
  'NZ.WNVZ_unfilt.h5', ...
  'NZ.WTVZ_unfilt.h5', ...
  'OV.VRBA_unfilt.h5'};

N_files = length(fn_list);

% --- Initialize
   lats = zeros(N_files, 1);
   lons = zeros(N_files, 1);
   dt = zeros(N_files, 1);
   my_labels = cell(N_files, 1);

   data_collection = cell(N_files,1); % all station data
   times_collection = cell(N_files,1); % all correponding time vectors

   D = zeros(N_files, 1); % distance from Tonga to each station

   E = wgs84Ellipsoid('meter'); % In order to let matlab calculate distance on between latitude, longitude points. In meters
   

% --- Loop over all files and setup a matrix with 
%     time and data as columns
for ii = 1:N_files
   
   disp(['Loading station ' num2str(ii) ' out of ' num2str(N_files)]);

   this_fn = fullfile(data_folder, fn_list{ii}); % The file path we will read
   info = h5info(this_fn);

   h5disp(this_fn); % Uncomment this if you want to display a quick look at the file contents

   % Read the data from the first group and the first dataset of the group
   group_string = info.Groups(1).Name;
   dataset_string = info.Groups(1).Datasets(1).Name;

   % Read the latitude and longitude attributes for the station and put into vectors
   lats(ii) = h5readatt(this_fn, '/', 'latitude');
   lons(ii) = h5readatt(this_fn, '/', 'longitude');

   % Read the sensor recording
   data = h5read(this_fn, [group_string '/' dataset_string]);
   data_collection{ii} = data; % put the data of the current station into a cell array (which will contain all stations' data)
   N_samples = length(data);

   % Figure out the start time and generate a time vector
   starttime_str = h5readatt(this_fn, [group_string '/' dataset_string], 'starttime');
   starttime = datetime(starttime_str, 'InputFormat', 'yyyy-MM-dd''T''HH:mm:ss.SSSSS''Z'''); % convert the timestamp to Matlab a datetime object
   dt(ii) = h5readatt(this_fn, [group_string '/' dataset_string], 'delta'); % in seconds
   deltas = seconds(linspace(0, dt(ii)*(N_samples-1), N_samples)).'; % a duration which can be added to a datetime object
   times = starttime + deltas; % our time vector in datetime format
   times_collection{ii,1} = times; % put the times for this station into a common cell array (which will contain all stations' data)

   % Calculate the great circle distance from this station to the Tonga event
   [D(ii), ~] = distance(tonga_latlon(1), tonga_latlon(2), lats(ii), lons(ii), E);

end % ii

% --- To get the standard coastlat coastlon data for map plotting
load coastlines

% --- Plot settings
   lw_line = 3;
   lw_volcano = 2;
   lw_station = 1;
   mz_station = 10; % marker size
   my_lightgray = [1 1 1]*.9;

   northward_offset = 90; % degrees latitude offset of the map centre
   plot_extent = 120.;% The width of the map plot in degrees
   
   

% --- Plotting the stations and the event locations on a map
fh = figure('position', [99 260 803 479],'color', 'w', 'defaultaxesfontsize', 10, 'defaultTextInterpreter', 'latex', 'defaultaxeslinewidth', 1.5, 'defaultlinelinewidth', lw_line, 'defaultaxestickdir', 'out', 'defaultAxesTickDirMode', 'manual', 'defaultaxesticklength', [0.003 0.003], 'defaultaxesTickLabelInterpreter', 'latex');

    set(gca(), 'xcolor', 'none', 'ycolor', 'none')
    
    my_proj = 'eqdazim';
    axesm('MapProjection', my_proj, 'origin', tonga_latlon + [northward_offset, 0], 'frame','on','grid','on', 'flatlimit', [-Inf plot_extent]); % Set up a special axes for mapping
    
    geoshow(coastlat, coastlon, 'displaytype','polygon', 'facecolor', my_lightgray) % plot the continental coastlines
    
    geoshow(tonga_latlon(1), tonga_latlon(2),'Marker','x','Color','red', 'markersize', 20, 'linewidth', lw_volcano) % plot the location of the volcano
    
    geoshow(lats, lons, 'Marker', '^', 'markersize', mz_station, 'linestyle', 'none', 'linewidth', lw_station); % Plot trangles on all station locations

% --- The provided impulse responses of filters 1, 2, 3
h1 = [9.3102e-04
  -1.2991e-18
  -1.1771e-03
  -8.9350e-04
   1.1279e-03
   2.3259e-03
  -3.0497e-18
  -3.7419e-03
  -2.8954e-03
   3.5886e-03
   7.1273e-03
  -6.7002e-18
  -1.0473e-02
  -7.7679e-03
   9.2793e-03
   1.7882e-02
  -1.0958e-17
  -2.5342e-02
  -1.8731e-02
   2.2575e-02
   4.4596e-02
  -1.4316e-17
  -7.1659e-02
  -6.0472e-02
   9.2253e-02
   3.0157e-01
   3.9980e-01
   3.0157e-01
   9.2253e-02
  -6.0472e-02
  -7.1659e-02
  -1.4316e-17
   4.4596e-02
   2.2575e-02
  -1.8731e-02
  -2.5342e-02
  -1.0958e-17
   1.7882e-02
   9.2793e-03
  -7.7679e-03
  -1.0473e-02
  -6.7002e-18
   7.1273e-03
   3.5886e-03
  -2.8954e-03
  -3.7419e-03
  -3.0497e-18
   2.3259e-03
   1.1279e-03
  -8.9350e-04
  -1.1771e-03
  -1.2991e-18
   9.3102e-04];

h2 = [6.8867e-04
  -1.0409e-18
  -8.7071e-04
  -1.6144e-04
   2.4454e-03
   4.3979e-03
   2.9653e-03
   1.8510e-04
   1.9464e-03
   9.1274e-03
   1.2922e-02
   5.3683e-03
  -6.4293e-03
  -6.1213e-03
   7.3124e-03
   1.0978e-02
  -1.3170e-02
  -4.5946e-02
  -4.7642e-02
  -1.5176e-02
  -2.2060e-03
  -5.5677e-02
  -1.3549e-01
  -1.3111e-01
   1.6668e-02
   2.2307e-01
   3.2035e-01
   2.2307e-01
   1.6668e-02
  -1.3111e-01
  -1.3549e-01
  -5.5677e-02
  -2.2060e-03
  -1.5176e-02
  -4.7642e-02
  -4.5946e-02
  -1.3170e-02
   1.0978e-02
   7.3124e-03
  -6.1213e-03
  -6.4293e-03
   5.3683e-03
   1.2922e-02
   9.1274e-03
   1.9464e-03
   1.8510e-04
   2.9653e-03
   4.3979e-03
   2.4454e-03
  -1.6144e-04
  -8.7071e-04
  -1.0409e-18
   6.8867e-04];

h3 = [-2.4366e-04
  -2.6135e-19
   3.0807e-04
   7.3294e-04
   1.3147e-03
   2.0667e-03
   2.9630e-03
   3.9300e-03
   4.8428e-03
   5.5289e-03
   5.7792e-03
   5.3643e-03
   4.0571e-03
   1.6578e-03
  -1.9803e-03
  -6.9275e-03
  -1.3160e-02
  -2.0549e-02
  -2.8859e-02
  -3.7759e-02
  -4.6838e-02
  -5.5636e-02
  -6.3672e-02
  -7.0487e-02
  -7.5676e-02
  -7.8923e-02
   9.2033e-01
  -7.8923e-02
  -7.5676e-02
  -7.0487e-02
  -6.3672e-02
  -5.5636e-02
  -4.6838e-02
  -3.7759e-02
  -2.8859e-02
  -2.0549e-02
  -1.3160e-02
  -6.9275e-03
  -1.9803e-03
   1.6578e-03
   4.0571e-03
   5.3643e-03
   5.7792e-03
   5.5289e-03
   4.8428e-03
   3.9300e-03
   2.9630e-03
   2.0667e-03
   1.3147e-03
   7.3294e-04
   3.0807e-04
  -2.6135e-19
  -2.4366e-04];
